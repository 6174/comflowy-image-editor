"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_constants=require("../../utils/constants"),_getElemDocumentCoords=_interopRequireDefault(require("../../utils/getElemDocumentCoords")),_getPointerOffsetPositionBoundedToObject=_interopRequireDefault(require("../../utils/getPointerOffsetPositionBoundedToObject")),_getBoundingRectUnScaled=_interopRequireDefault(require("./getBoundingRectUnScaled")),_getNewAnnotationPreview=_interopRequireWildcard(require("./getNewAnnotationPreview")),_excluded=["id","x","y","points"],_excluded2=["startedX","startedY","offsetX","offsetY","width","height"];function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var pointerDown={startedX:void 0,startedY:void 0,isOutOfCanvas:!1},eventsOptions={passive:!0},MIN_PIXELS=1,shownAnnotationPreview=null,textAnnotationWrappedRect=null,latestAnnotationProps=null,previewThenCallAnnotationAdding=function(a,b,c,d){var f=function getCanvasBoundingRect(){return(0,_getElemDocumentCoords["default"])(a.content)},g=function wrapTextBoundsPreviewByRect(a){textAnnotationWrappedRect=(0,_getNewAnnotationPreview["default"])(_objectSpread(_objectSpread({},a),{},{name:_constants.TOOLS_IDS.RECT,fill:"",stroke:"#000000",strokeWidth:2,shadowColor:"#ffffff",shadowBlur:1,shadowOpacity:.7})),c.add(textAnnotationWrappedRect)},h=function previewAnnotation(a){shownAnnotationPreview=(0,_getNewAnnotationPreview["default"])(a),c.add(shownAnnotationPreview),a.name===_constants.TOOLS_IDS.TEXT&&g(a),latestAnnotationProps=a},i=function updateAnnotationPreview(a,b){var c=(0,_getNewAnnotationPreview.dimensToProperAnnotationDimens)(a,latestAnnotationProps.name,b);textAnnotationWrappedRect&&textAnnotationWrappedRect.setAttrs(c),shownAnnotationPreview.setAttrs(c),latestAnnotationProps=_objectSpread(_objectSpread({},latestAnnotationProps),c)},j=function updatePreviewWithBoundedDimens(a){var b=(0,_getPointerOffsetPositionBoundedToObject["default"])(c,f());i((0,_getBoundingRectUnScaled["default"])(b,pointerDown,c),a.shiftKey)},k=function destroyShownPreview(){c&&shownAnnotationPreview&&c.destroyChildren()},l=function handlePointerMove(d){var e;if(!(1<(null===(e=d.evt.touches)||void 0===e?void 0:e.length))){var g=(0,_getPointerOffsetPositionBoundedToObject["default"])(c,f());pointerDown.isOutOfCanvas&&(document.removeEventListener("mousemove",j,eventsOptions),document.removeEventListener("touchmove",j,eventsOptions),pointerDown.isOutOfCanvas=!1);var k=(0,_getBoundingRectUnScaled["default"])(g,pointerDown,c);if(shownAnnotationPreview)i(k,d.evt.shiftKey);else{var l=b.id,m=b.x,n=b.y,o=b.points,p=(0,_objectWithoutProperties2["default"])(b,_excluded);h(_objectSpread(_objectSpread({},p),k))}a.setAttrs({isDrawing:!0})}},m=function handlePointerOut(){pointerDown.isOutOfCanvas||(document.addEventListener("mousemove",j,eventsOptions),document.addEventListener("touchmove",j,eventsOptions),pointerDown.isOutOfCanvas=!0)},n=function handlePointerUp(){var c,e;if(k(),latestAnnotationProps&&(latestAnnotationProps.width>=MIN_PIXELS&&latestAnnotationProps.height>=MIN_PIXELS||latestAnnotationProps.radiusX>=MIN_PIXELS&&latestAnnotationProps.radiusY>=MIN_PIXELS||null!==(c=latestAnnotationProps.points)&&void 0!==c&&c[2]||null!==(e=latestAnnotationProps.points)&&void 0!==e&&e[3]||latestAnnotationProps.radius>=MIN_PIXELS)){var f=latestAnnotationProps,g=f.startedX,h=f.startedY,i=f.offsetX,o=f.offsetY,p=f.width,q=f.height,r=(0,_objectWithoutProperties2["default"])(f,_excluded2);_getNewAnnotationPreview.NO_WIDTH_HEIGHT_ANNOTATIONS.includes(b.name)||(r.width=p,r.height=q),d(r,!0)}shownAnnotationPreview=null,textAnnotationWrappedRect=null,latestAnnotationProps=null,a.setAttrs({isDrawing:!1}),a.off("mousemove touchmove",l),a.off("mouseleave touchcancel",m),document.removeEventListener("mouseup",n,eventsOptions),document.removeEventListener("touchend",n,eventsOptions),document.removeEventListener("mouseleave",n,eventsOptions),document.removeEventListener("touchcancel",n,eventsOptions),document.removeEventListener("mousemove",j,eventsOptions),document.removeEventListener("touchmove",j,eventsOptions),pointerDown.isOutOfCanvas=!1},o=function handlePointerDown(b){var d;if(b.evt.preventDefault(),!(b.target.attrs.draggable||1<(null===(d=b.evt.touches)||void 0===d?void 0:d.length))){k();var e=(0,_getPointerOffsetPositionBoundedToObject["default"])(c,f());pointerDown.startedX=e.offsetX,pointerDown.startedY=e.offsetY,pointerDown.isOutOfCanvas=!1,a.on("mousemove touchmove",l),a.on("mouseleave touchcancel",m),document.addEventListener("mouseup",n,eventsOptions),document.addEventListener("touchend",n,eventsOptions),document.addEventListener("mouseleave",n,eventsOptions),document.addEventListener("touchcancel",n,eventsOptions)}};return a.on("mousedown touchstart",o),function(){k(),a.off("mousedown touchstart",o)}},_default=exports["default"]=previewThenCallAnnotationAdding;