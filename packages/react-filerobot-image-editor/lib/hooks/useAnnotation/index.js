"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_react=require("react"),_actions=require("../../actions"),_randomId=_interopRequireDefault(require("../../utils/randomId")),_debounce=_interopRequireDefault(require("../../utils/debounce")),_constants=require("../../utils/constants"),_=require("./.."),_previewThenCallAnnotationAdding=_interopRequireDefault(require("./previewThenCallAnnotationAdding")),_useDebouncedCallback=_interopRequireDefault(require("../useDebouncedCallback")),_excluded=["fonts","onFontChange"],_excluded2=["x","y","width","height","radius","radiusX","radiusY","points","image","text","scaleX","scaleY","rotation"],_excluded3=["shouldSave","neverSave"];function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var useAnnotation=function(){var a,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],d=(0,_.useStore)(),e=d.dispatch,f=d.previewGroup,g=d.annotations,h=d.selectionsIds,i=void 0===h?[]:h,j=d.config,k=_objectSpread(_objectSpread({},j.annotationsCommon),j[(null===(a=g[i[0]])||void 0===a?void 0:a.name)||b.name]),l=(0,_react.useState)(function(){return _objectSpread(_objectSpread(_objectSpread({},k),b),g[i[0]])}),m=(0,_slicedToArray2["default"])(l,2),n=m[0],o=m[1],p=(0,_react.useRef)(),q=null===f||void 0===f?void 0:f.getStage(),r=(0,_react.useCallback)(function(a){var c=a.fonts,d=a.onFontChange,f=(0,_objectWithoutProperties2["default"])(a,_excluded);e({type:_actions.SET_ANNOTATION,payload:f}),f.id&&b.name!==_constants.TOOLS_IDS.PEN&&(0,_debounce["default"])(function(){e({type:_actions.SELECT_ANNOTATION,payload:{annotationId:f.id}})},30)()},[]),s=(0,_useDebouncedCallback["default"])(function(a){o(function(b){return _objectSpread(_objectSpread({},b),{},{shouldSave:!1,neverSave:!1},"function"==typeof a?a(b):a)})},15),t=(0,_react.useCallback)(function(a,c){if(a.name===c){var d=a.x,e=a.y,f=a.width,g=a.height,h=a.radius,i=a.radiusX,j=a.radiusY,l=a.points,m=a.image,n=a.text,o=a.scaleX,p=a.scaleY,q=a.rotation,r=(0,_objectWithoutProperties2["default"])(a,_excluded2);return _objectSpread(_objectSpread(_objectSpread({},k),b),r)}return _objectSpread(_objectSpread({},k),b)},[]),u=(0,_react.useCallback)(function(a){o(function(c){var d=t(c,a.name||b.name);return _objectSpread(_objectSpread(_objectSpread({},d),a),{},{id:a.id||(0,_randomId["default"])(a.name||c.name),shouldSave:!0,neverSave:!1})})},[]);return(0,_react.useEffect)(function(){var a=n.shouldSave,b=n.neverSave,c=(0,_objectWithoutProperties2["default"])(n,_excluded3),d=1===i.length&&g[i[0]];!b&&(a||d)&&r(_objectSpread(_objectSpread({},c),{},{id:a?c.id:d.id}))},[n]),(0,_react.useEffect)(function(){setTimeout(function(){1===i.length?(p.current=n,o(_objectSpread(_objectSpread({},g[i[0]]),{},{neverSave:!0}))):p.current&&(o(_objectSpread(_objectSpread({},p.current),{},{neverSave:!0})),p.current=null)})},[i,g]),(0,_react.useEffect)(function(){var a=null;if(q&&c){var d=t(n,b.name);a=(0,_previewThenCallAnnotationAdding["default"])(q,_objectSpread(_objectSpread({},d),{},{name:b.name}),f,u)}return function(){a&&a()}},[q,n,f]),(0,_react.useMemo)(function(){return[n,s,u]},[n,s,u])},_default=exports["default"]=useAnnotation;