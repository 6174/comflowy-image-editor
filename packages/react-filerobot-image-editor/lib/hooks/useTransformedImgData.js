import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";var _excluded=["filter"];function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import Konva from"konva";import{HIDE_LOADER,SET_SAVED}from"../actions";import{ELLIPSE_CROP,IMAGE_NODE_ID,SUPPORTED_IMAGE_TYPES,TOOLS_IDS}from"../utils/constants";import extractCurrentDesignState from"../utils/extractCurrentDesignState";import mapCropBox from"../utils/mapCropBox";import getSizeAfterRotation from"../utils/getSizeAfterRotation";import imageToBase64 from"../utils/imageToBase64";import getFileFullName from"../utils/getFileFullName";import operationsToCloudimageUrl from"../utils/operationsToCloudimageUrl";import useStore from"./useStore";var useTransformedImgData=function(){var a=useStore(),b=a.dispatch,c=a.designLayer,d=a.shownImageDimensions,e=a.originalImage,f=a.resize,g=a.adjustments,h=g.crop,i=g.rotation,j=void 0===i?0:i,k=g.isFlippedX,l=g.isFlippedY,m=a.config,n=m.savingPixelRatio,o=m.previewPixelRatio,p=m.forceToPngInEllipticalCrop,q=m.defaultSavedImageType,r=m.useCloudimage,s=m.cloudimage,t=m[TOOLS_IDS.CROP];return r?function getTransformedCloudimageData(){var b,c,f=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},g=extractCurrentDesignState(a),i=g.filter,j=_objectWithoutProperties(g,_excluded),k=operationsToCloudimageUrl(s,j,d,e,t),l=mapCropBox({x:h.x,y:h.y,width:h.width,height:h.height},d,e),m={cloudimageUrl:k,width:(null===f||void 0===f||null===(b=f.size)||void 0===b?void 0:b.width)||l.width,height:(null===f||void 0===f||null===(c=f.size)||void 0===c?void 0:c.height)||l.height};return{imageData:m,designState:j}}:function getTransformedImgData(){var g=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],m=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],o=_objectSpread({size:f},g);Konva.pixelRatio=i||n;var r=c.attrs,s=r.clipWidth,t=r.clipHeight,u=r.clipX,v=r.clipY;c.setAttr("isSaving",!0);var w=c.getStage().clone({width:e.width,height:e.height,scaleX:k?-1:1,scaleY:l?-1:1}),x=_slicedToArray(w.children,1),y=x[0];w.children[1].destroy();var z=w.findOne("#".concat(IMAGE_NODE_ID));z.cache();var A={x:w.width()/d.width,y:w.height()/d.height};y.setAttrs({rotation:0,offsetX:0,offsetY:0,x:0,y:0,scaleX:A.x,scaleY:A.y});var B=_objectSpread(_objectSpread({},(!o.name||!o.extension)&&getFileFullName(e.name,p&&h.ratio===ELLIPSE_CROP?"png":SUPPORTED_IMAGE_TYPES.includes(null===q||void 0===q?void 0:q.toLowerCase())&&q)),o),C=B.name,D=B.extension,E=B.quality,F=void 0===E?92:E,G=B.size,H=void 0===G?{}:G,I=["jpeg","jpg","webp"].includes(D),J=mapCropBox(h.noEffect?{x:0,y:0}:{x:h.x||u,y:h.y||v,width:h.width||s,height:h.height||t},d,w.attrs),K=getSizeAfterRotation(J.width,J.height,j);if(w.setAttrs({offsetX:J.width/2+J.x,offsetY:J.height/2+J.y,width:K.width,height:K.height,x:K.width/2,y:K.height/2,rotation:j}),H.width){var L=(k?-1:1)*(H.width/w.width());w.setAttrs({scaleX:L,width:H.width,x:w.x()*Math.abs(L)})}if(H.height){var M=(l?-1:1)*(H.height/w.height());w.setAttrs({scaleY:M,height:H.height,y:w.y()*Math.abs(M)})}var N=_objectSpread({mimeType:"image/".concat("jpg"===D?"jpeg":D)},I?{quality:F}:{}),O=w.toCanvas(N),P=w.toDataURL(N),Q=_objectSpread(_objectSpread({},extractCurrentDesignState(a)),{},{shownImageDimensions:{width:a.shownImageDimensions.width,height:a.shownImageDimensions.height,scaledBy:a.shownImageDimensions.scaledBy}});Q.filter&&(Q.filter=Q.filter.filterName||Q.filter.name),Q.finetunes=Q.finetunes.map(function(a){return a.finetuneName||a.name}),Object.keys(Q.annotations).forEach(function(a){var b,c=Q.annotations[a],d=c.name===TOOLS_IDS.IMAGE&&(null===(b=c.image)||void 0===b?void 0:b.src);d&&d.startsWith("blob:")?Q.annotations[a].image=imageToBase64(c.image):c.image instanceof HTMLImageElement&&(Q.annotations[a].image=d)});var R=_objectSpread({fullName:"".concat(C,".").concat(D),name:C,extension:D,mimeType:"image/".concat(D),imageCanvas:O,imageBase64:P,width:H.width||J.width,height:H.height||J.height},I?{quality:F}:{});c.setAttr("isSaving",!1),b({type:SET_SAVED}),z.clearCache(),Konva.pixelRatio=4;var S=function(){b({type:HIDE_LOADER})};return m||S(),{imageData:R,designState:Q,hideLoadingSpinner:S}}};export default useTransformedImgData;