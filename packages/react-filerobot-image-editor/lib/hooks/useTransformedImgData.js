"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_konva=_interopRequireDefault(require("konva")),_actions=require("../actions"),_constants=require("../utils/constants"),_extractCurrentDesignState=_interopRequireDefault(require("../utils/extractCurrentDesignState")),_mapCropBox=_interopRequireDefault(require("../utils/mapCropBox")),_getSizeAfterRotation=_interopRequireDefault(require("../utils/getSizeAfterRotation")),_imageToBase=_interopRequireDefault(require("../utils/imageToBase64")),_getFileFullName=_interopRequireDefault(require("../utils/getFileFullName")),_operationsToCloudimageUrl=_interopRequireDefault(require("../utils/operationsToCloudimageUrl")),_useStore=_interopRequireDefault(require("./useStore")),_excluded=["filter"];function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var useTransformedImgData=function(){var a=(0,_useStore["default"])(),b=a.dispatch,c=a.designLayer,d=a.shownImageDimensions,e=a.originalImage,f=a.resize,g=a.adjustments,h=g.crop,i=g.rotation,j=void 0===i?0:i,k=g.isFlippedX,l=g.isFlippedY,m=a.config,n=m.savingPixelRatio,o=m.previewPixelRatio,p=m.forceToPngInEllipticalCrop,q=m.defaultSavedImageType,r=m.useCloudimage,s=m.cloudimage,t=m[_constants.TOOLS_IDS.CROP];return r?function getTransformedCloudimageData(){var b,c,f=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},g=(0,_extractCurrentDesignState["default"])(a),i=g.filter,j=(0,_objectWithoutProperties2["default"])(g,_excluded),k=(0,_operationsToCloudimageUrl["default"])(s,j,d,e,t),l=(0,_mapCropBox["default"])({x:h.x,y:h.y,width:h.width,height:h.height},d,e),m={cloudimageUrl:k,width:(null===f||void 0===f||null===(b=f.size)||void 0===b?void 0:b.width)||l.width,height:(null===f||void 0===f||null===(c=f.size)||void 0===c?void 0:c.height)||l.height};return{imageData:m,designState:j}}:function getTransformedImgData(){var g=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],m=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],r=_objectSpread({size:f},g);_konva["default"].pixelRatio=i||n;var s=c.attrs,t=s.clipWidth,u=s.clipHeight,v=s.clipX,w=s.clipY;c.setAttr("isSaving",!0);var x=c.getStage().clone({width:e.width,height:e.height,scaleX:k?-1:1,scaleY:l?-1:1}),y=(0,_slicedToArray2["default"])(x.children,1),z=y[0];x.children[1].destroy();var A=x.findOne("#".concat(_constants.IMAGE_NODE_ID));A.cache();var B={x:x.width()/d.width,y:x.height()/d.height};z.setAttrs({rotation:0,offsetX:0,offsetY:0,x:0,y:0,scaleX:B.x,scaleY:B.y});var C=_objectSpread(_objectSpread({},(!r.name||!r.extension)&&(0,_getFileFullName["default"])(e.name,p&&h.ratio===_constants.ELLIPSE_CROP?"png":_constants.SUPPORTED_IMAGE_TYPES.includes(null===q||void 0===q?void 0:q.toLowerCase())&&q)),r),D=C.name,E=C.extension,F=C.quality,G=void 0===F?92:F,H=C.size,I=void 0===H?{}:H,J=["jpeg","jpg","webp"].includes(E),K=(0,_mapCropBox["default"])(h.noEffect?{x:0,y:0}:{x:h.x||v,y:h.y||w,width:h.width||t,height:h.height||u},d,x.attrs),L=(0,_getSizeAfterRotation["default"])(K.width,K.height,j);if(x.setAttrs({offsetX:K.width/2+K.x,offsetY:K.height/2+K.y,width:L.width,height:L.height,x:L.width/2,y:L.height/2,rotation:j}),I.width){var M=(k?-1:1)*(I.width/x.width());x.setAttrs({scaleX:M,width:I.width,x:x.x()*Math.abs(M)})}if(I.height){var N=(l?-1:1)*(I.height/x.height());x.setAttrs({scaleY:N,height:I.height,y:x.y()*Math.abs(N)})}var O=_objectSpread({mimeType:"image/".concat("jpg"===E?"jpeg":E)},J?{quality:G}:{}),P=x.toCanvas(O),Q=x.toDataURL(O),R=_objectSpread(_objectSpread({},(0,_extractCurrentDesignState["default"])(a)),{},{shownImageDimensions:{width:a.shownImageDimensions.width,height:a.shownImageDimensions.height,scaledBy:a.shownImageDimensions.scaledBy}});R.filter&&(R.filter=R.filter.filterName||R.filter.name),R.finetunes=R.finetunes.map(function(a){return a.finetuneName||a.name}),Object.keys(R.annotations).forEach(function(a){var b,c=R.annotations[a],d=c.name===_constants.TOOLS_IDS.IMAGE&&(null===(b=c.image)||void 0===b?void 0:b.src);d&&d.startsWith("blob:")?R.annotations[a].image=(0,_imageToBase["default"])(c.image):c.image instanceof HTMLImageElement&&(R.annotations[a].image=d)});var S=_objectSpread({fullName:"".concat(D,".").concat(E),name:D,extension:E,mimeType:"image/".concat(E),imageCanvas:P,imageBase64:Q,width:I.width||K.width,height:I.height||K.height},J?{quality:G}:{});c.setAttr("isSaving",!1),b({type:_actions.SET_SAVED}),A.clearCache(),_konva["default"].pixelRatio=o;var T=function(){b({type:_actions.HIDE_LOADER})};return m||T(),{imageData:S,designState:R,hideLoadingSpinner:T}}},_default=exports["default"]=useTransformedImgData;