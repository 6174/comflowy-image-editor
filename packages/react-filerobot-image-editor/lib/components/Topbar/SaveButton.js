"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_menuItem=_interopRequireDefault(require("@scaleflex/ui/core/menu-item")),_icons=require("@scaleflex/icons"),_label=_interopRequireDefault(require("@scaleflex/ui/core/label")),_hooks=require("../../hooks"),_getFileFullName2=_interopRequireDefault(require("../../utils/getFileFullName")),_getDefaultSaveQuality=_interopRequireDefault(require("../../utils/getDefaultSaveQuality")),_constants=require("../../utils/constants"),_actions=require("../../actions"),_Modal=_interopRequireDefault(require("../common/Modal")),_Slider=_interopRequireDefault(require("../common/Slider")),_restrictNumber=_interopRequireDefault(require("../../utils/restrictNumber")),_Resize=require("../tools/Resize"),_ButtonWithMenu=_interopRequireDefault(require("../common/ButtonWithMenu")),_Topbar=require("./Topbar.styled");function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var sliderStyle={marginBottom:16},saveButtonWrapperStyle={minWidth:67,width:"fit-content"},saveButtonMenuStyle={marginLeft:12},isFieSaveMounted=!0,SaveButton=function(){var a=(0,_hooks.useStore)(),b=(0,_react.useRef)(),c=a.theme,d=a.dispatch,e=a.originalImage,f=a.resize,g=a.isLoadingGlobally,h=a.haveNotSavedChanges,i=a.feedback,j=a.hasUndo,k=a.t,l=a.adjustments,m=void 0===l?{}:l,n=m.crop,o=a.config,p=o.onClose,q=o.closeAfterSave,r=o.onBeforeSave,s=o.onSave,t=o.forceToPngInEllipticalCrop,u=o.defaultSavedImageName,v=o.defaultSavedImageType,w=o.defaultSavedImageQuality,x=void 0===w?_constants.DEFAULT_SAVE_QUALITY:w,y=o.useCloudimage,z=o.moreSaveOptions,A=o.disableSaveIfNoChanges,B=o.removeSaveButton,C=(0,_react.useState)(!1),D=(0,_slicedToArray2["default"])(C,2),E=D[0],F=D[1],G=(0,_react.useState)({quality:(0,_getDefaultSaveQuality["default"])(x)}),H=(0,_slicedToArray2["default"])(G,2),I=H[0],J=H[1],K=(0,_hooks.useTransformedImgData)(),L=["jpeg","jpg","webp"].includes(I.extension),M=0===i.duration,N=function handleSave(){var a=K(I,!1,!0),c=b.current||s,e=c(a.imageData,a.designState),f=function hideLoadingSpinner(){d({type:_actions.HIDE_LOADER})};e instanceof Promise?e["finally"](f):f(),b.current=null,q&&p&&p(_constants.CLOSING_REASONS.AFTER_SAVE,h)},O=function startSaving(){d({type:_actions.SHOW_LOADER}),F(!1),setTimeout(N,3)},P=function validateInfoThenSave(){var a=b.current||s;if("function"!=typeof a)throw new Error("Please provide onSave function handler.");return I.name&&I.extension?void O():void d({type:_actions.SET_FEEDBACK,payload:{feedback:{message:k("nameIsRequired")}}})},Q=function triggerSaveHandler(){if(!A||j){if(y){var a=K(I),c=b.current||s;return void c(a.imageData,a.designState)}return b.current||"function"!=typeof r||!1!==r(I)?void F(!0):void P()}},R=function changeSaveFnAndTriggerAnother(a,c){if("function"==typeof a)b.current=a,c();else throw new Error("onSave function callback is required as an argument to the passed function.")},S=function setFileNameAndExtension(){var a=(0,_getFileFullName2["default"])(u||e.name,t&&n.ratio===_constants.ELLIPSE_CROP?"png":_constants.SUPPORTED_IMAGE_TYPES.includes(null===v||void 0===v?void 0:v.toLowerCase())&&v),b=a.name,c=a.extension;J(_objectSpread(_objectSpread({},I),{},{name:b,extension:c}))};if((0,_react.useEffect)(function(){e&&S()},[e]),(0,_react.useEffect)(function(){!e||I.name&&I.extension||S()},[E]),(0,_react.useEffect)(function(){J(_objectSpread(_objectSpread({},I),{},{size:{width:f.width,height:f.height}}))},[f]),(0,_react.useEffect)(function(){return isFieSaveMounted=!0,function(){isFieSaveMounted=!1}},[]),B)return null;var T=Array.isArray(z)&&0<z.length?z.map(function(a,b){return _objectSpread(_objectSpread({},a),{},{key:"".concat(a.label||b,"-option-key"),onClick:"function"==typeof a.onClick?function(){return a.onClick(function(a){return R(a,Q)},function(a){return R(a,O)})}:void 0})}):[];return _react["default"].createElement(_react["default"].Fragment,null,_react["default"].createElement(_ButtonWithMenu["default"],{className:"FIE_topbar-save",color:"primary",onClick:Q,menuPosition:"bottom",menuFromBtn:!0,label:0<T.length?k("saveAs"):k("save"),menuItems:T,menuStyle:saveButtonMenuStyle,wrapperStyle:saveButtonWrapperStyle,disabled:g||A&&!j||M,noMargin:!0}),E&&_react["default"].createElement(_Modal["default"],{className:"FIE_save-modal",title:k("saveAsModalTitle"),Icon:function Icon(a){return _react["default"].createElement(_icons.Image2,(0,_extends2["default"])({color:c.palette["accent-primary"]},a))},isOpened:E,onCancel:function cancelModal(){isFieSaveMounted&&E&&(b.current=null,F(!1))},onDone:P,doneLabel:k("save"),cancelLabel:k("cancel"),doneButtonColor:"primary",areButtonsDisabled:g,zIndex:11110},_react["default"].createElement(_Topbar.StyledFileNameInput,{className:"FIE_save-file-name-input",value:I.name,onChange:function changeFileName(a){var b=a.target.value;J(_objectSpread(_objectSpread({},I),{},{name:b}))},size:"sm",label:k("name"),placeholder:k("imageName"),error:!I.name,fullWidth:!0,focusOnMount:!0}),_react["default"].createElement(_Topbar.StyledFileExtensionSelect,{className:"FIE_save-extension-selector",onChange:function onChange(a){return J(_objectSpread(_objectSpread({},I),{},{extension:a}))},value:I.extension,label:k("format"),placeholder:k("extension"),size:"sm",fullWidth:!0},_constants.SUPPORTED_IMAGE_TYPES.map(function(a){return _react["default"].createElement(_menuItem["default"],{key:a,value:a},a)})),L&&_react["default"].createElement(_Topbar.StyledQualityWrapper,{className:"FIE_save-quality-wrapper"},_react["default"].createElement(_label["default"],null,k("quality")),_react["default"].createElement(_Slider["default"],{annotation:"%",min:1,max:100,onChange:function changeQuality(a){J(_objectSpread(_objectSpread({},I),{},{quality:(0,_restrictNumber["default"])(a/100,.01,1)}))},value:parseInt(100*I.quality,10),width:"100%",style:sliderStyle})),_react["default"].createElement(_Topbar.StyledResizeOnSave,{className:"FIE_save-resize-wrapper"},_react["default"].createElement(_Topbar.StyledResizeOnSaveLabel,null,k("resize")),_react["default"].createElement(_Resize.Resize,{onChange:function resizeImageFile(a){J(_objectSpread(_objectSpread({},I),{},{size:_objectSpread(_objectSpread({},I.size),a)}))},currentSize:(null===I||void 0===I?void 0:I.size)||{},hideResetButton:!0,alignLeft:!0,disableWrap:!0,alignment:"space-between"}))))},_default=exports["default"]=SaveButton;