"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_MainCanvas=_interopRequireDefault(require("../MainCanvas")),_constants=require("../../utils/constants"),_Topbar=_interopRequireDefault(require("../Topbar")),_Tabs=_interopRequireDefault(require("../Tabs")),_ToolsBar=_interopRequireDefault(require("../ToolsBar")),_actions=require("../../actions"),_FeedbackPopup=_interopRequireDefault(require("../FeedbackPopup")),_loadImage=_interopRequireDefault(require("../../utils/loadImage")),_hooks=require("../../hooks"),_Spinner=_interopRequireDefault(require("../common/Spinner")),_translator=require("../../utils/translator"),_cloudimageQueryToDesignState=_interopRequireDefault(require("../../utils/cloudimageQueryToDesignState")),_finetunesStrsToClasses=_interopRequireDefault(require("../../utils/finetunesStrsToClasses")),_filterStrToClass=_interopRequireDefault(require("../../utils/filterStrToClass")),_isSameImage=_interopRequireDefault(require("../../utils/isSameImage")),_TabsDrawer=_interopRequireDefault(require("../TabsDrawer")),_App=require("./App.styled");function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof3(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var App=function(){var a=(0,_hooks.useStore)(),b=a.config,c=a.isLoadingGlobally,d=a.haveNotSavedChanges,e=a.dispatch,f=a.originalImage,g=a.shownImageDimensions,h=a.t,i=a.theme,j=a.feedback,k=void 0===j?{}:j,l=b.loadableDesignState,m=b.useCloudimage,n=b.cloudimage,o=b.source,p=b.avoidChangesNotSavedAlertOnLeave,q=b.useBackendTranslations,r=b.translations,s=b.language,t=b.defaultSavedImageName,u=b.observePluginContainerSize,v=b.showCanvasOnly,w=b.getCurrentImgDataFnRef,x=b.updateStateFnRef,y=b.noCrossOrigin,z=window.matchMedia("(max-width: 760px)").matches,A=(0,_hooks.useResizeObserver)(),B=(0,_slicedToArray2["default"])(A,2),C=B[0],D=B[1],E=(0,_react.useState)({width:void 0,height:void 0}),F=(0,_slicedToArray2["default"])(E,2),G=F[0],H=F[1],I=(0,_hooks.usePhoneScreen)(),J=(0,_react.useRef)(null),K=(0,_react.useRef)(!0),L=(0,_react.useRef)(!1),M=(0,_react.useRef)(null),N=(0,_react.useRef)(d),O=(0,_hooks.useTransformedImgData)(),P=(0,_react.useCallback)(function(a){e({type:_actions.SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),Q=(0,_react.useCallback)(function(a){e({type:_actions.SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),R=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(M.current===c||!c&&f||(0,_isSameImage["default"])(c,f))return void(M.current||b());var d=function(){M.current=null,b()};M.current=c,setTimeout(function(){if("string"==typeof a)(0,_loadImage["default"])(a,t,y).then(P)["catch"](Q)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&t&&(a.name=t),!a.complete)return void a.addEventListener("load",function(){P(a),d()});P(a),d()}else Q(h("invalidImageError")),d()},0)})},S=function(a){N.current&&(a.preventDefault(),a.returnValue="")},T=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return e({type:_actions.SHOW_LOADER}),Promise.all(a())["finally"](function(){e({type:_actions.HIDE_LOADER})})},U=function(){l&&0<Object.keys(l).length&&e({type:_actions.UPDATE_STATE,payload:_objectSpread(_objectSpread({},l),{},{finetunes:(0,_finetunesStrsToClasses["default"])(null===l||void 0===l?void 0:l.finetunes),filter:(0,_filterStrToClass["default"])(null===l||void 0===l?void 0:l.filter)})})};(0,_react.useEffect)(function(){K.current||!o||(0,_isSameImage["default"])(o,f)||(L.current=!1,T(function(){return[R(o)]}))},[o]),(0,_react.useEffect)(function(){if(!K.current){var a=null===l||void 0===l?void 0:l.imgSrc;a&&!(0,_isSameImage["default"])(a,f)?T(function(){return[R(a).then(U)]}):U()}},[l]),(0,_react.useEffect)(function(){0<Object.keys(g||{}).length&&!Object.keys(g).some(function(a){return!g[a]})&&f&&m&&null!==n&&void 0!==n&&n.loadableQuery&&!L.current&&(e({type:_actions.UPDATE_STATE,payload:(0,_cloudimageQueryToDesignState["default"])(n.loadableQuery,g,f)}),L.current=!0)},[g,f,m,n]),(0,_react.useEffect)(function(){var a=!1;return u&&J.current?C(J.current.parentNode,function(a){var b=a.width,c=a.height;return H({width:b,height:c})}):G.width&&G.height&&!a&&H({width:void 0,height:void 0}),function(){u&&J.current&&D(J.current),a=!0}},[u]),(0,_react.useEffect)(function(){return T(function initialRequestsPromisesFn(){return[R((null===l||void 0===l?void 0:l.imgSrc)||o)].concat((0,_toConsumableArray2["default"])(q?[(0,_translator.getBackendTranslations)(s,r)]:[]))}),K.current=!1,window&&!p&&window.addEventListener("beforeunload",S),function(){window&&!p&&window.removeEventListener("beforeunload",S)}},[]),(0,_react.useEffect)(function(){x&&"object"===(0,_typeof2["default"])(x)&&(x.current=function(a){e({type:_actions.UPDATE_STATE,payload:a})})},[x,e]),(0,_react.useEffect)(function(){w&&"object"===(0,_typeof2["default"])(w)&&(w.current=O)},[O]),(0,_react.useEffect)(function(){N.current=d},[d]);var V=function(a){e({type:_actions.SET_SHOWN_TABS_MENU,payload:{opened:a}})};return _react["default"].createElement(_App.StyledAppWrapper,{className:_constants.ROOT_CONTAINER_CLASS_NAME,"data-phone":I,showTabsDrawer:z,ref:J,$size:G},c&&_react["default"].createElement(_Spinner["default"],{theme:i}),function renderContent(){return _react["default"].createElement(_react["default"].Fragment,null,!v&&_react["default"].createElement(_react["default"].Fragment,null,z&&_react["default"].createElement(_TabsDrawer["default"],{toggleMainMenu:V}),_react["default"].createElement(_Topbar["default"],{toggleMainMenu:V})),f&&0!==k.duration&&_react["default"].createElement(_App.StyledMainContent,{className:"FIE_main-container"},!v&&!z&&_react["default"].createElement(_App.StyledTabs,{className:"FIE_tabs"},_react["default"].createElement(_Tabs["default"],{toggleMainMenu:V})),_react["default"].createElement(_App.StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:z},_react["default"].createElement(_MainCanvas["default"],null),!v&&_react["default"].createElement(_ToolsBar["default"],{isPhoneScreen:I}))))}(),_react["default"].createElement(_FeedbackPopup["default"],null))},_default=exports["default"]=(0,_react.memo)(App);