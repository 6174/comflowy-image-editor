"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_react=_interopRequireWildcard(require("react")),_reactKonva=require("react-konva"),_konva=_interopRequireDefault(require("konva")),_hooks=require("../../../hooks"),_actions=require("../../../actions"),_constants=require("../../../utils/constants"),_TransformersLayer=require("./TransformersLayer.utils"),_TextNode=_interopRequireDefault(require("../DesignLayer/AnnotationNodes/TextNode"));function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var isFirstRenderCropUpdated=!1,noEffectTextDimensions={width:200,height:100},CropTransformer=function(){var a=(0,_hooks.useStore)(),b=a.dispatch,c=a.theme,d=a.designLayer,e=a.originalImage,f=a.shownImageDimensions,g=a.adjustments,h=void 0===g?{}:g,i=h.crop,j=void 0===i?{}:i,k=h.isFlippedX,l=h.isFlippedY,m=a.resize,n=void 0===m?{}:m,o=a.config,p=a.t,q=(0,_react.useRef)(),r=(0,_react.useRef)(),s=(0,_react.useRef)(),t=(0,_react.useRef)(),u=o[_constants.TOOLS_IDS.CROP],v=(0,_react.useMemo)(function(){var a;return _objectSpread(_objectSpread({},u),{},{lockCropAreaAt:null!==(a=j.lockCropAreaAt)&&void 0!==a?a:null===u||void 0===u?void 0:u.lockCropAreaAt})},[j.lockCropAreaAt,u]),w=v.lockCropAreaAt,z=j.ratio||v.ratio,A=z===_constants.CUSTOM_CROP,B=z===_constants.ELLIPSE_CROP,C=function(){return z===_constants.ORIGINAL_CROP?e.width/e.height:z},D=function(a,c){var d=a.width,e=a.height,g=a.x,h=a.y,i={x:k?f.width-g-d:g,y:l?f.height-h-e:h,width:d,height:e},m=j.width>=n.width&&j.height>=n.height;n.width&&n.height&&(d<n.width||e<n.height)&&m&&b({type:_actions.SET_FEEDBACK,payload:{feedback:{message:p("cropSizeLowerThanResizedWarning"),status:_constants.FEEDBACK_STATUSES.WARNING}}}),b({type:_actions.SET_CROP,payload:_objectSpread(_objectSpread(_objectSpread({},j),i),{},{dismissHistory:c})})},E=function(a,b){var c,d;r.current&&q.current&&r.current.nodes([q.current]);var e=t.current,f={width:a,height:b,x:null!==(c=j.x)&&void 0!==c?c:0,y:null!==(d=j.y)&&void 0!==d?d:0};D((0,_TransformersLayer.boundResizing)(f,f,_objectSpread(_objectSpread({},e),{},{abstractX:0,abstractY:0}),!(A||B)&&C(),v),!0)};if((0,_react.useEffect)(function(){return d&&r.current&&q.current&&(s.current&&s.current.cache(),r.current.nodes([q.current])),function(){s.current&&s.current.clearCache()}},[d,e,f]),(0,_react.useEffect)(function(){if(t.current){var a,b,c=t.current;E(null!==(a=j.width)&&void 0!==a?a:c.width,null!==(b=j.height)&&void 0!==b?b:c.height)}},[z]),(0,_react.useEffect)(function(){r.current&&q.current&&t.current&&j.width&&j.height&&E(j.width,j.height)},[v,f.width,f.height]),(0,_react.useEffect)(function(){if(f&&(t.current=f,!isFirstRenderCropUpdated&&z&&f.x&&f.width)){var a,b;E(null!==(a=j.width)&&void 0!==a?a:f.width,null!==(b=j.height)&&void 0!==b?b:f.height),isFirstRenderCropUpdated=!0}},[f]),!d)return null;var F,G=(w||j.noEffect)&&[]||(A||B?void 0:["top-left","bottom-left","top-right","bottom-right"]),H=function(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];a.target&&D({width:a.target.width()*a.target.scaleX(),height:a.target.height()*a.target.scaleY(),x:a.target.x(),y:a.target.y()},b)};if(!j.width&&!j.height){var I=1>f.scaledBy?f.scaledBy:1,J=_objectSpread(_objectSpread({},f),{},{width:f.width/I,height:f.height/I});F=(0,_TransformersLayer.boundResizing)(J,_objectSpread(_objectSpread({},J),{},{x:0,y:0}),_objectSpread(_objectSpread({},J),{},{abstractX:0,abstractY:0}),!(A||B)&&C(),v)}else F=j;var K=F,L=K.x,M=void 0===L?0:L,x=K.y,N=void 0===x?0:x,y=K.width,O=K.height,P={x:k?f.width-M-y:M,y:l?f.height-N-O:N,ref:q,fill:"#FFFFFF",scaleX:1,scaleY:1,globalCompositeOperation:"destination-out",onDragEnd:w?void 0:H,onDragMove:w?void 0:function limitDragging(a){var b=a.target;b.setAttrs((0,_TransformersLayer.boundDragging)(b.attrs,t.current))},onTransformEnd:w?void 0:H,draggable:!w};return _react["default"].createElement(_react["default"].Fragment,null,_react["default"].createElement(_reactKonva.Image,{image:e,x:k?f.width:0,y:l?f.height:0,width:f.width,height:f.height,filters:[_konva["default"].Filters.Blur,_konva["default"].Filters.Brighten],blurRadius:10,brightness:-.3,scaleX:k?-1:1,scaleY:l?-1:1,ref:s}),B?_react["default"].createElement(_reactKonva.Ellipse,(0,_extends2["default"])({},P,{radiusX:y/2,radiusY:O/2,offset:{x:-y/2,y:-O/2}})):_react["default"].createElement(_reactKonva.Rect,(0,_extends2["default"])({},P,{width:j.noEffect?0:y,height:j.noEffect?0:O})),j.noEffect&&_react["default"].createElement(_TextNode["default"],{name:"Text",id:"no-preview-text-node",text:p("cropItemNoEffect"),x:f.width/2-noEffectTextDimensions.width/2,y:f.height/2-noEffectTextDimensions.height/2,fontSize:20,fill:"#ffffff",stroke:"#ff0000",strokeWidth:.2,shadowColor:"#ff0000",shadowBlur:10,annotationEvents:{},align:"center",width:noEffectTextDimensions.width,height:noEffectTextDimensions.height}),_react["default"].createElement(_reactKonva.Transformer,{centeredScaling:!1,flipEnabled:!1,rotateEnabled:!1,nodes:q.current?[q.current]:[],anchorSize:14,anchorCornerRadius:7,enabledAnchors:G,ignoreStroke:!1,anchorStroke:c.palette["accent-primary"],anchorFill:c.palette["access-primary"],anchorStrokeWidth:2,borderStroke:c.palette["accent-primary"],borderStrokeWidth:2,borderDash:[4],keepRatio:!A||!B,ref:r,boundBoxFunc:function boundBoxFunc(a,b){return(0,_TransformersLayer.boundResizing)(a,b,t.current,!(A||B)&&C(),v)}}))},_default=exports["default"]=CropTransformer;