"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_hooks=require("../../../hooks"),_constants=require("../../../utils/constants"),_AnnotationOptions=_interopRequireDefault(require("../../common/AnnotationOptions")),_getPointerOffsetPositionBoundedToObject=_interopRequireDefault(require("../../../utils/getPointerOffsetPositionBoundedToObject")),_randomId=_interopRequireDefault(require("../../../utils/randomId")),_actions=require("../../../actions"),_getElemDocumentCoords=_interopRequireDefault(require("../../../utils/getElemDocumentCoords"));function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var eventsOptions={passive:!0},PenOptions=function(a){var b=a.t,c=(0,_hooks.useStore)(),d=c.dispatch,e=c.designLayer,f=c.previewGroup,g=c.config,h=(0,_hooks.useAnnotation)(_objectSpread(_objectSpread(_objectSpread({},g.annotationsCommon),g[_constants.TOOLS_IDS.PEN]),{},{name:_constants.TOOLS_IDS.PEN}),!1),i=(0,_slicedToArray2["default"])(h,3),j=i[0],k=i[1],l=i[2],m=(0,_react.useRef)(null),n=(0,_react.useRef)({points:[],moved:!1,id:""}),o=(0,_react.useCallback)(function(){var a=(0,_getElemDocumentCoords["default"])(m.current.content),b=(0,_getPointerOffsetPositionBoundedToObject["default"])(f,a);return[b.offsetX-(e.attrs.xPadding||0),b.offsetY-(e.attrs.yPadding||0)]},[e]),p=(0,_react.useCallback)(function(){n.current.moved?(n.current.points=n.current.points.concat(o()),d({type:_actions.SET_ANNOTATION,payload:{id:n.current.id,points:n.current.points,dismissHistory:!0}})):(n.current={moved:!0,id:(0,_randomId["default"])(_constants.TOOLS_IDS.PEN),points:[].concat((0,_toConsumableArray2["default"])(n.current.points),(0,_toConsumableArray2["default"])(o()))},l({id:n.current.id,name:_constants.TOOLS_IDS.PEN,points:n.current.points}))},[o]),q=(0,_react.useCallback)(function(){n.current.id&&g[_constants.TOOLS_IDS.PEN].selectAnnotationAfterDrawing&&d({type:_actions.SELECT_ANNOTATION,payload:{annotationId:n.current.id}}),n.current=null,m.current.off("mousemove touchmove",p),m.current.off("mouseleave touchcancel",q),document.removeEventListener("mouseup",q,eventsOptions),document.removeEventListener("touchend",q,eventsOptions),document.removeEventListener("mouseleave",q,eventsOptions),document.removeEventListener("touchcancel",q,eventsOptions)},[p]),r=(0,_react.useCallback)(function(a){a.target.attrs.draggable||(a.evt.preventDefault(),n.current={points:o()},m.current.on("mousemove touchmove",p),m.current.on("mouseleave touchcancel",q),document.addEventListener("mouseup",q,eventsOptions),document.addEventListener("touchend",q,eventsOptions),document.addEventListener("mouseleave",q,eventsOptions),document.addEventListener("touchcancel",q,eventsOptions))},[o,p,q]);return(0,_react.useEffect)(function(){return m.current=null===e||void 0===e?void 0:e.getStage(),m.current&&m.current.on("mousedown touchstart",r),function(){m.current&&m.current.off("mousedown touchstart",r)}},[e]),_react["default"].createElement(_AnnotationOptions["default"],{className:"FIE_pen-tool-options",annotation:j,updateAnnotation:k,t:b,hidePositionField:!0,hideFillOption:!0})},_default=exports["default"]=PenOptions;