"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_icons=require("@scaleflex/icons"),_hooks=require("../../../hooks"),_constants=require("../../../utils/constants"),_actions=require("../../../actions"),_HiddenUploadInput=_interopRequireDefault(require("../../common/HiddenUploadInput")),_ButtonWithMenu=_interopRequireDefault(require("../../common/ButtonWithMenu")),_ImageControls=_interopRequireDefault(require("./ImageControls")),_ImagesGallery=_interopRequireDefault(require("./ImagesGallery"));function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}var ADDED_IMG_SPACING_PERCENT=.15,ImageOptions=function(){var a=(0,_react.useState)(),b=(0,_slicedToArray2["default"])(a,2),c=b[0],d=b[1],e=(0,_react.useState)(null),f=(0,_slicedToArray2["default"])(e,2),g=f[0],h=f[1],i=(0,_react.useRef)(),j=(0,_react.useRef)(),k=(0,_hooks.useStore)(),l=k.shownImageDimensions,m=k.dispatch,n=k.adjustments.crop,o=void 0===n?{}:n,p=k.t,q=k.config,r=void 0===q?{}:q,s=r[_constants.TOOLS_IDS.IMAGE],t=!s.disableUpload,u=Array.isArray(s.gallery)&&0<s.gallery.length,v=(0,_hooks.useAnnotation)({name:_constants.TOOLS_IDS.IMAGE,opacity:1},!1),w=(0,_slicedToArray2["default"])(v,3),x=w[0],y=w[1],z=w[2],A=(0,_react.useRef)(0),B=function(a){var b=o.width||l.width,c=o.height||l.height,d=o.x||0,e=o.y||0,f=Math.min(1,b/(a.width+a.width*ADDED_IMG_SPACING_PERCENT),c/(a.height+a.height*ADDED_IMG_SPACING_PERCENT));z({image:a,x:d+b/2-a.width*f/2,y:e+c/2-a.height*f/2,width:a.width*f,height:a.height*f})},C=function(a){A.current+=1,A.current===a&&(A.current=0,d(!1))},D=function(a){m({type:_actions.SET_FEEDBACK,payload:{feedback:{message:a,status:_constants.FEEDBACK_STATUSES.WARNING}}})},E=function(){i.current&&i.current.click()},F=function(){h(j.current)},G=(0,_react.useMemo)(function(){return[t&&{key:"add-by-upload-image",label:c?p("importing"):p("uploadImage"),icon:_icons.UploadOutline,onClick:c?void 0:E},u&&{key:"add-from-gallery",label:p("fromGallery"),icon:_icons.Images,onClick:F}]},[s,c,p]);return _react["default"].createElement(_ImageControls["default"],{image:x,saveImage:y,t:p},_react["default"].createElement(_ButtonWithMenu["default"],{className:"FIE_image-tool-add-option",color:"secondary",label:p("addImage"),title:p("addImageTitle"),menuPosition:"top",menuItems:G,size:"sm",style:{maxHeight:24},buttonRef:j,menuFromBtn:!0}),t&&_react["default"].createElement(_HiddenUploadInput["default"],{ref:i,onChange:c?void 0:function importImages(a){if(a.target.files){d(!0);var b=[],c=Array.from(a.target.files),e=c.length;if(c.forEach(function(a){if(a.type.startsWith("image/")){var c=new Image;c.onload=function(){B(c),URL.revokeObjectURL(a),C(e)},c.onerror=function(){D(p("uploadImageError")),C(e)},c.src=URL.createObjectURL(a)}else b.push(a.name),C(e)}),0<b.length){var f=1<b.length?p("areNotImages"):p("isNotImage");D("".concat(b.join(", ")," ").concat(f," ").concat(p("toBeUploaded"),"."))}}a.target.value=""},disabled:c,multiple:!0}),u&&_react["default"].createElement(_ImagesGallery["default"],{gallery:s.gallery,onSelect:function importImgFromGallery(a){d(!0);var b=new Image;b.onload=function(){B(b),C(1)},b.onerror=function(){D(p("uploadImageError")),C(1)},b.crossOrigin="Anonymous",b.src=a},onClose:function closeGalleryPanel(){h(null)},anchorEl:g}))},_default=exports["default"]=ImageOptions;