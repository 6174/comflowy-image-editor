"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_text=_interopRequireDefault(require("@scaleflex/icons/text")),_uploadOutline=_interopRequireDefault(require("@scaleflex/icons/upload-outline")),_actions=require("../../../actions"),_ButtonWithMenu=_interopRequireDefault(require("../../common/ButtonWithMenu")),_TextControls=_interopRequireDefault(require("../Text/TextOptions/TextControls")),_ImageControls=_interopRequireDefault(require("../Image/ImageControls")),_hooks=require("../../../hooks"),_constants=require("../../../utils/constants"),_HiddenUploadInput=_interopRequireDefault(require("../../common/HiddenUploadInput")),_Watermark=require("./Watermark.styled"),_WatermarksGallery=_interopRequireDefault(require("./WatermarksGallery")),_WatermarkPadding=_interopRequireDefault(require("./WatermarkPadding"));function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=_typeof(b)&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e["default"]=b,d&&d.set(b,e),e}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var WATERMARK_IMG_RATIO_FROM_ORIGINAL=.33,WATERMARK_ANNOTATION_ID="watermark",Watermark=function(){var a=(0,_hooks.useStore)(),b=a.annotations,c=a.shownImageDimensions,d=a.selectionsIds,e=a.config,f=a.dispatch,g=a.t,h=a.adjustments.crop,i=void 0===h?{}:h,j=(0,_hooks.usePhoneScreen)(),k=(0,_react.useState)(!1),l=(0,_slicedToArray2["default"])(k,2),m=l[0],n=l[1],o=(0,_react.useRef)(),p=e[_constants.TOOLS_IDS.WATERMARK],q=(0,_react.useMemo)(function(){return b[WATERMARK_ANNOTATION_ID]},[b[WATERMARK_ANNOTATION_ID]]),r=i.width||c.width,s=i.height||c.height,t=i.x||0,u=i.y||0,v=p.textScalingRatio||WATERMARK_IMG_RATIO_FROM_ORIGINAL,w=p.imageScalingRatio||WATERMARK_IMG_RATIO_FROM_ORIGINAL,x=function(a){var b=a.width/a.height,c={};if(s>r){var d=s*w/a.height;c.height=a.height*d,c.width=c.height*b}else{var g=r*w/a.width;c.width=a.width*g,c.height=c.width/b}var h=_objectSpread(_objectSpread(_objectSpread(_objectSpread({},e.annotationsCommon),e[_constants.TOOLS_IDS.IMAGE]),c),{},{padding:1,image:a,x:t+r/2-c.width/2,y:u+s/2-c.height/2,id:WATERMARK_ANNOTATION_ID,name:_constants.TOOLS_IDS.IMAGE,replaceCurrent:!0});f({type:_actions.SET_ANNOTATION,payload:h})},y=function(a){f({type:_actions.SET_ANNOTATION,payload:_objectSpread(_objectSpread({},"function"==typeof a?a(q):a),{},{id:WATERMARK_ANNOTATION_ID})})},z=function(a){f({type:_actions.SET_FEEDBACK,payload:{feedback:{message:a,status:_constants.FEEDBACK_STATUSES.WARNING}}})},A=function(a,b){if(a){n(!0);var c=new Image;c.onload=function(){x(c),b&&URL.revokeObjectURL(a),n(!1)},c.onerror=function(){z(g("mutualizedFailedToLoadImg")),b&&URL.revokeObjectURL(a),n(!1)},c.src=a}};(0,_react.useEffect)(function(){q&&(f({type:_actions.CLEAR_ANNOTATIONS_SELECTIONS}),f({type:_actions.SELECT_ANNOTATION,payload:{annotationId:"watermark"}}))},[q]),(0,_react.useEffect)(function(){q&&(0===d.length||d[0].id!==WATERMARK_ANNOTATION_ID)&&f({type:_actions.SELECT_ANNOTATION,payload:{annotationId:"watermark"}})},[d]);var B=[(!e.useCloudimage||"function"==typeof p.onUploadWatermarkImgClick)&&{key:"upload-watermark",label:g("uploadWatermark"),icon:_uploadOutline["default"],onClick:function handleUploadWatermarkClick(){if("function"==typeof p.onUploadWatermarkImgClick){var a=p.onUploadWatermarkImgClick(A);return void(a instanceof Promise&&a.then(function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.url,c=a.revokeObjectUrl;return A(b,void 0!==c&&c)}))}o.current&&o.current.click()}},!p.hideTextWatermark&&{key:"add-text-watermark",label:g("addWatermarkAsText"),icon:_text["default"],onClick:function addTextWatermark(){var a={height:s*v,width:r*v},b=_objectSpread(_objectSpread(_objectSpread(_objectSpread({},e.annotationsCommon),e[_constants.TOOLS_IDS.TEXT]),a),{},{padding:1,x:t+r/2-a.width/2,y:u+s/2-a.height/2,fill:"#000000",id:WATERMARK_ANNOTATION_ID,name:_constants.TOOLS_IDS.TEXT,replaceCurrent:!0});f({type:_actions.SET_ANNOTATION,payload:b})}}],C=function(){return _react["default"].createElement(_WatermarkPadding["default"],{watermark:q,saveWatermark:y,t:g})};return _react["default"].createElement("div",{className:"FIE_watermark-tool-wrapper"},(null===q||void 0===q?void 0:q.name)===_constants.TOOLS_IDS.TEXT&&_react["default"].createElement(_Watermark.StyledControlsWrapper,{className:"FIE_watermark-options-wrapper"},_react["default"].createElement(_TextControls["default"],{text:q,saveText:y,t:g},C())),(null===q||void 0===q?void 0:q.name)===_constants.TOOLS_IDS.IMAGE&&_react["default"].createElement(_Watermark.StyledControlsWrapper,{className:"FIE_watermark-options-wrapper"},_react["default"].createElement(_ImageControls["default"],{image:q,saveImage:y,t:g},C())),_react["default"].createElement(_Watermark.StyledWatermarkWrapper,{className:"FIE_watermark-add-wrapper",noWrap:!0},_react["default"].createElement(_ButtonWithMenu["default"],{className:"FIE_watermark-add",color:"secondary",label:function addWatermarkLabel(){return j?g("plus"):B[0]?g("addWatermark"):g("addTextWatermark")}(),title:g("addWatermarkTitle"),menuPosition:"top",menuItems:B,menuFromBtn:!0,noMargin:!0}),_react["default"].createElement(_WatermarksGallery["default"],{loadAndSetWatermarkImg:A,addImgWatermark:x,style:j&&!(!(null!==q&&void 0!==q)||!q.name)?{width:"55%"}:void 0}),_react["default"].createElement(_HiddenUploadInput["default"],{onChange:m?void 0:function importWatermarkImg(a){if(a.target.files){var b=a.target.files[0];b.type.startsWith("image/")&&A(URL.createObjectURL(b),!0)}a.target.value=""},disabled:m,ref:o})))},_default=exports["default"]=Watermark;