"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_konva=_interopRequireDefault(require("konva")),_constants=require("./constants"),_deepMerge=_interopRequireDefault(require("./deepMerge")),_mapNumber=_interopRequireDefault(require("./mapNumber")),_operationsToCloudimageUrl=require("./operationsToCloudimageUrl"),_excluded=["cropX2","cropY2","crop","watermark"];function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var propertyToOperation=function(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{},e=_constants.CLOUDIMG_TO_EDITOR_POSITIONS[b];switch(a){case"wat_text":return{watermark:{text:b.replaceAll("+"," ")}};case"wat_font":return{watermark:{fontFamily:b}};case"wat_color":return{watermark:{fill:"#".concat(b)}};case"wat_fontsize":return{watermark:{fontSize:parseFloat(b)}};case"wat_opacity":return{watermark:{opacity:parseFloat(b)}};case"wat_pos":{var f=b.split(","),g=(0,_slicedToArray2["default"])(f,2),h=g[0],i=g[1];return{watermark:{x:parseFloat(h)/100*c.width,y:parseFloat(i)/100*c.height}}}case"wat_url":return{watermark:{image:decodeURIComponent(b)}};case"wat_scale":{var j=b.split(","),k=(0,_slicedToArray2["default"])(j,2),l=k[0],m=k[1];return{watermark:{width:parseFloat(l)/100*(c.width||0),height:parseFloat(m)/100*(c.height||0)}}}case"tl_px":{var n=b.split(","),o=(0,_slicedToArray2["default"])(n,2),p=o[0],q=o[1];return{crop:{x:(0,_mapNumber["default"])(parseFloat(p),0,d.width,0,c.width),y:(0,_mapNumber["default"])(parseFloat(q),0,d.height,0,c.height)}}}case"br_px":{var r=b.split(","),s=(0,_slicedToArray2["default"])(r,2),t=s[0],u=s[1];return{cropX2:(0,_mapNumber["default"])(parseFloat(t),0,d.width,0,c.width),cropY2:(0,_mapNumber["default"])(parseFloat(u),0,d.height,0,c.height)}}case"round":return{crop:{ratio:_constants.ELLIPSE_CROP}};case"gravity":return{crop:e?{lockCropAreaAt:e,width:null,height:null}:{noEffect:!0,ratio:b,ratioTitleKey:b,width:null,height:null}};case"aspect_ratio":return{crop:{ratio:+b}};case"w":return{resize:{width:parseFloat(b)}};case"h":return{resize:{height:parseFloat(b)}};case"r":return{adjustments:{rotation:-parseInt(b,10)}};case"flip":case"mirror":return{adjustments:{isFlippedX:b.includes("x")||b.includes("h"),isFlippedY:b.includes("y")||b.includes("v")}};default:{var v;if(Object.keys(_operationsToCloudimageUrl.finetuneNameToParamInfo).forEach(function(b){_operationsToCloudimageUrl.finetuneNameToParamInfo[b].cloudimage.name===a.toLowerCase()&&(v=b)}),!v)return null;var w=_operationsToCloudimageUrl.finetuneNameToParamInfo[v],x=w.cloudimage,y=w.internal;return{finetunes:[_konva["default"].Filters[v]],finetunesProps:(0,_defineProperty2["default"])({},y.propName,(0,_mapNumber["default"])(parseFloat(b),x.min,x.max,y.min,y.max))}}}},cloudimageQueryToDesignState=function(a,b,c){if(!a)return null;var d=a.split("&"),e={};d.forEach(function(a){var d=a.split("="),f=(0,_slicedToArray2["default"])(d,2),g=f[0],h=f[1],i=propertyToOperation(g,h,b,c);i&&(e=(0,_deepMerge["default"])(e,i,!0))});var f=e,g=f.cropX2,h=f.cropY2,i=f.crop,j=f.watermark,k=(0,_objectWithoutProperties2["default"])(f,_excluded),l=_objectSpread(_objectSpread(_objectSpread({},k),g&&h&&i||null!==i&&void 0!==i&&i.noEffect||null!==i&&void 0!==i&&i.lockCropAreaAt?{adjustments:_objectSpread(_objectSpread({},k.adjustments),{},{crop:_objectSpread({width:(g||0)-i.x,height:(h||0)-i.y},i)})}:{}),{},{annotations:_objectSpread({},j?(0,_defineProperty2["default"])({},_constants.WATERMARK_ANNOTATION_ID,_objectSpread(_objectSpread({},j),{},{x:((null===i||void 0===i?void 0:i.x)||0)+(j.x||0),y:((null===i||void 0===i?void 0:i.y)||0)+(j.y||0),id:_constants.WATERMARK_ANNOTATION_ID,name:j.text?_constants.TOOLS_IDS.TEXT:_constants.TOOLS_IDS.IMAGE},j.text?{width:j.text.length*j.fontSize,height:j.fontSize}:{})):{})});return l},_default=exports["default"]=cloudimageQueryToDesignState;